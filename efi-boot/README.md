## **EFI Bootable Image**

To boot an image with EFI firmware, we need a PE executable ([PE format](pe.svg)).

The code in the executable should be Position Independent Code (PIC).

The image consists of three parts
1.  PE header ([header.S](header.S))
2.  de-compressor ([efi.c](efi.c) and [deflate.c](deflate.c))
3.  ukernel

The standard method is to compile PE header and de-compressor as PIC code and embed the ukernel as payload in final image using, see [efi-boot.lds](efi-boot.lds). The firmware starts the de-compressor which should extract and run the ukernel.

How the image is generated is architecture dependant.

### **x86\_64**

PE header and de-compressor are compiled separately. First, the de-compressor is compiled as _**PIC code at offset 0**_ while PE header is compile as a non-PIC header. The necessary information, including
- address of EFI entry (`efi_pe_entry`),
- size of code (`_data`),
- size of initialized data (`_end - _data`), and
- size of raw data (`_edata - _data`)

are extracted from the image.

The de-compressor carries the compressed ukernel.

```
SECTIONS
{
    . = 0;
    .text : {
        _text = .;
        *(.text)
        _etext = .;
    }

    .rodata : {
        _rodata = .;
        *(.rodata)
        _erodata = .;
    }

    . = ALIGN(PAGE_SIZE);
    .data : {
        _data = .;
        *(.data)
        _edata = .;
    }

    .bss : {
        _bss = .;
        *(.bss)
        _ebss = .;
    }

    . = ALIGN(PAGE_SIZE);
    _end = .; 
}
```

These information are extracted using `nm` and `sed` to produce macros. These macros are included and used by the PE headers. Finally, the PE executable is generated by appending the de-compressor image to the PE header.

- Using standard method for x86\_64 generates this error:  
**relocation R\_X86\_64\_32 against symbol \`\_\_data\_size' can not be used when making a PIE object**
